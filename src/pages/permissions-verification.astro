---
// permissions-verification.astro - Page to verify all permissions are correctly implemented
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Verificación de Permisos - HexaLink ERP">
  <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
    <h1 style="color: #0d9488; margin-bottom: 2rem;">Matriz de Permisos - HexaLink ERP</h1>

    <div id="permission-matrix" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <!-- Will be populated by JavaScript -->
    </div>

    <div style="margin-top: 2rem; background: #f0f9f8; border-left: 4px solid #0d9488; padding: 1rem; border-radius: 4px;">
      <h3 style="color: #0d9488; margin-top: 0;">Credenciales de Demo:</h3>
      <ul style="margin: 0; padding-left: 1.5rem;">
        <li><strong>Admin:</strong> admin@hexalink.com / demo123</li>
        <li><strong>HR:</strong> hr@hexalink.com / demo123</li>
        <li><strong>Employee:</strong> juan.perez@hexalink.com / demo123</li>
        <li><strong>Candidate:</strong> candidate@hexalink.com / demo123</li>
      </ul>
    </div>

    <div style="margin-top: 2rem; background: #f9f3f0; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 4px;">
      <h3 style="color: #ef4444; margin-top: 0;">Estado Actual:</h3>
      <div id="current-user">No autenticado</div>
    </div>
  </div>

  <script is:inline>
    // Load permissions matrix
    const permissionsData = {
      admin: {
        name: 'Admin (GERENTE)',
        pages: [
          'Admin Dashboard',
          'Manage Employees (CRUD)',
          'Manage Vacations (Approve/Reject)',
          'Manage Candidates',
          'Search Module (Internal/External)',
          'Manage Vacancies (CRUD)',
          'My Profile',
          'Vacations',
          'Notifications',
          'Reports',
          'Settings'
        ]
      },
      hr: {
        name: 'HR (Módulos Vinculados)',
        pages: [
          'Manage Employees (View/Edit)',
          'Manage Vacations (Approve/Reject)',
          'Manage Candidates (CRUD)',
          'Search Module (Internal/External)',
          'Manage Vacancies (HR view)',
          'My Profile',
          'Vacations',
          'Notifications'
        ]
      },
      employee: {
        name: 'Employee',
        pages: [
          'My Profile (View/Edit Basic)',
          'Vacations (View/Request/Cancel)',
          'Notifications',
          'Vacancies (View Public)'
        ]
      },
      candidate: {
        name: 'Candidate',
        pages: [
          'Vacancies (View)',
          'Apply to Vacancy'
        ]
      }
    };

    // Create matrix table
    const matrix = document.getElementById('permission-matrix');
    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
    
    // Header
    html += '<thead><tr style="background: #f0f9f8; border-bottom: 2px solid #0d9488;">';
    html += '<th style="padding: 1rem; text-align: left; border-right: 1px solid #e2e8f0;">Role</th>';
    html += '<th style="padding: 1rem; text-align: left;">Pages/Features</th>';
    html += '</tr></thead>';
    
    // Body
    html += '<tbody>';
    for (const [roleKey, roleData] of Object.entries(permissionsData)) {
      html += `<tr style="border-bottom: 1px solid #e2e8f0;">
        <td style="padding: 1rem; font-weight: 600; color: #0d9488; background: #f8fffe; min-width: 150px; vertical-align: top;">${roleData.name}</td>
        <td style="padding: 1rem; vertical-align: top;">
          <ul style="margin: 0; padding-left: 1.5rem;">
            ${roleData.pages.map(page => `<li style="margin-bottom: 0.25rem;">${page}</li>`).join('')}
          </ul>
        </td>
      </tr>`;
    }
    html += '</tbody></table></div>';
    
    matrix.innerHTML = html;

    // Update current user info
    const userDiv = document.getElementById('current-user');
    const user = localStorage.getItem('user');
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

    if (user && isLoggedIn) {
      try {
        const userData = JSON.parse(user);
        userDiv.innerHTML = `
          ✅ <strong>Email:</strong> ${userData.email}<br/>
          ✅ <strong>Role:</strong> ${userData.role.toUpperCase()}<br/>
          <button onclick="location.href='/login'" style="margin-top: 0.5rem; background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
            Change User
          </button>
        `;
      } catch (e) {
        userDiv.innerHTML = '❌ Invalid session';
      }
    } else {
      userDiv.innerHTML = '❌ No autenticado - <a href="/login" style="color: #0d9488; font-weight: 600;">Login</a>';
    }
  </script>
</BaseLayout>
